name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: daygen-backend
  SERVICE_NAME: daygen-backend
  REGION: europe-central2
  REGISTRY: europe-central2-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "Building and pushing image: $IMAGE_TAG"
          
          # Build the image
          docker build --platform linux/amd64 -t $IMAGE_TAG .
          
          # Push the image
          docker push $IMAGE_TAG
          
          # Also tag as latest for easier reference
          docker tag $IMAGE_TAG ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image $IMAGE_TAG \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 3000 \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            --set-env-vars "DIRECT_URL=${{ secrets.DIRECT_URL }}" \
            --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars "CLOUDFLARE_R2_ACCOUNT_ID=${{ secrets.CLOUDFLARE_R2_ACCOUNT_ID }}" \
            --set-env-vars "CLOUDFLARE_R2_ACCESS_KEY_ID=${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}" \
            --set-env-vars "CLOUDFLARE_R2_SECRET_ACCESS_KEY=${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}" \
            --set-env-vars "CLOUDFLARE_R2_BUCKET_NAME=${{ secrets.CLOUDFLARE_R2_BUCKET_NAME }}" \
            --set-env-vars "CLOUDFLARE_R2_PUBLIC_URL=${{ secrets.CLOUDFLARE_R2_PUBLIC_URL }}" \
            --set-env-vars "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
            --set-env-vars "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" \
            --set-env-vars "BFL_API_KEY=${{ secrets.BFL_API_KEY }}" \
            --set-env-vars "IDEOGRAM_API_KEY=${{ secrets.IDEOGRAM_API_KEY }}" \
            --set-env-vars "DASHSCOPE_API_KEY=${{ secrets.DASHSCOPE_API_KEY }}" \
            --set-env-vars "RUNWAY_API_KEY=${{ secrets.RUNWAY_API_KEY }}" \
            --set-env-vars "ARK_API_KEY=${{ secrets.ARK_API_KEY }}" \
            --set-env-vars "REVE_API_KEY=${{ secrets.REVE_API_KEY }}" \
            --set-env-vars "RECRAFT_API_KEY=${{ secrets.RECRAFT_API_KEY }}" \
            --set-env-vars "LUMAAI_API_KEY=${{ secrets.LUMAAI_API_KEY }}" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" \
            --set-env-vars "GOOGLE_CLOUD_LOCATION=${{ env.REGION }}" \
            --set-env-vars "API_BASE_URL=https://${{ env.SERVICE_NAME }}-${{ env.PROJECT_ID }}.a.run.app" \
            --set-env-vars "INTERNAL_API_KEY=${{ secrets.INTERNAL_API_KEY }}"

      - name: Test deployment
        run: |
          SERVICE_URL="https://${{ env.SERVICE_NAME }}-${{ env.PROJECT_ID }}.a.run.app"
          echo "Testing deployment at: $SERVICE_URL"
          
          # Wait a moment for the service to be ready
          sleep 30
          
          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health")
          echo "Health check response: $HEALTH_RESPONSE"
          
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "‚úÖ Deployment successful! Service is healthy."
            curl -s "$SERVICE_URL/health" | jq .
          else
            echo "‚ùå Deployment failed! Health check returned: $HEALTH_RESPONSE"
            exit 1
          fi

      - name: Output service URL
        run: |
          echo "üöÄ Service deployed successfully!"
          echo "üåê Service URL: https://${{ env.SERVICE_NAME }}-${{ env.PROJECT_ID }}.a.run.app"
          echo "üìä Check logs with: gcloud run logs tail ${{ env.SERVICE_NAME }} --region=${{ env.REGION }}"
