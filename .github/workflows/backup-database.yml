name: Daily Database Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Manual trigger button

jobs:
  backup:
    runs-on: ubuntu-latest
    environment: production
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      # DATABASE_URL is provided via job-level env above
      
      - name: Create database backup
        run: |
          mkdir -p backups
          timestamp=$(date +%Y%m%d_%H%M%S)
          backup_file="daygen_backup_${timestamp}.sql"
          
          echo "ðŸ”„ Creating database backup..."
          echo "Backup file: ${backup_file}"
          
          # Debug: Check if DATABASE_URL is set (without exposing the full URL)
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ DATABASE_URL environment variable is not set"
            exit 1
          else
            echo "âœ… DATABASE_URL is set (length: ${#DATABASE_URL})"
            # Show just the host part for debugging
            db_host=$(echo "$DATABASE_URL" | sed -E 's|.*@([^:/?]+).*|\1|')
            echo "Database host: ${db_host}"
          fi
          
          # Force IPv4 to avoid runner IPv6 issues
          ipv4=$(getent ahostsv4 "$db_host" | awk 'NR==1{print $1}')
          if [ -n "$ipv4" ]; then
            export PGHOSTADDR="$ipv4"
            echo "ðŸ“¡ Using IPv4 address: $PGHOSTADDR"
          else
            echo "âš ï¸ Could not resolve IPv4 for $db_host; continuing without forcing IPv4"
          fi
          
          # Connectivity check
          echo "ðŸ”Ž Testing DB connectivity..."
          set +e
          psql "$DATABASE_URL" -Atc "SELECT current_database(), current_user, version();" > /tmp/psql_check.txt 2>&1
          psql_exit=$?
          set -e
          if [ $psql_exit -ne 0 ]; then
            echo "âŒ psql connectivity check failed (exit $psql_exit)"
            echo "psql output:" && head -n 200 /tmp/psql_check.txt
            exit 1
          else
            echo "âœ… psql connectivity OK"
            echo "psql output:" && head -n 5 /tmp/psql_check.txt
          fi

          # Create backup
          echo "ðŸ” Running pg_dump command..."
          # Temporarily disable exit-on-error to capture pg_dump failure details
          set +e
          pg_dump "$DATABASE_URL" > "backups/${backup_file}" 2>&1
          pg_dump_exit_code=$?
          set -e
          
          if [ $pg_dump_exit_code -ne 0 ]; then
            echo "âŒ pg_dump failed with exit code: $pg_dump_exit_code"
            echo "Error output (first 120 lines):"
            if [ -f "backups/${backup_file}" ]; then
              head -n 120 "backups/${backup_file}"
            else
              echo "No output file created"
            fi
            exit 1
          fi
          
          # Check if backup was created successfully
          if [ ! -f "backups/${backup_file}" ]; then
            echo "âŒ Backup creation failed"
            exit 1
          fi

          # Ensure file is not empty and appears to contain SQL
          if [ ! -s "backups/${backup_file}" ]; then
            echo "âŒ Backup file is empty"
            exit 1
          fi

          if ! grep -Eq '^(CREATE|COPY) ' "backups/${backup_file}"; then
            echo "âŒ Backup content looks suspicious (no CREATE/COPY statements found)"
            echo "Showing first 40 lines for debugging:"
            head -n 40 "backups/${backup_file}"
            exit 1
          fi

          echo "âœ… Backup created successfully"
          ls -la "backups/${backup_file}"
          
          # Compress backup
          echo "ðŸ—œï¸ Compressing backup..."
          gzip "backups/${backup_file}"
          
          echo "âœ… Backup compressed: backups/${backup_file}.gz"
          ls -la "backups/${backup_file}.gz"
      
      - name: Upload backup to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backups/
          retention-days: 30
      
      - name: Create backup summary
        run: |
          latest=$(ls -t backups/*.gz | head -n1)
          echo "## ðŸ“Š Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup File**: $(basename "$latest")" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h "$latest" | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
