name: Daily Database Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Manual trigger button

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          mkdir -p backups
          timestamp=$(date +%Y%m%d_%H%M%S)
          backup_file="daygen_backup_${timestamp}.sql"
          
          echo "ðŸ”„ Creating database backup..."
          echo "Backup file: ${backup_file}"
          
          # Debug: Check if DATABASE_URL is set (without exposing the full URL)
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ DATABASE_URL environment variable is not set"
            exit 1
          else
            echo "âœ… DATABASE_URL is set (length: ${#DATABASE_URL})"
            # Show just the host part for debugging
            echo "Database host: $(echo $DATABASE_URL | cut -d'@' -f2 | cut -d':' -f1)"
          fi
          
          # Create backup
          echo "ðŸ” Running pg_dump command..."
          pg_dump "$DATABASE_URL" > "backups/${backup_file}" 2>&1
          pg_dump_exit_code=$?
          
          if [ $pg_dump_exit_code -ne 0 ]; then
            echo "âŒ pg_dump failed with exit code: $pg_dump_exit_code"
            echo "Error output:"
            cat "backups/${backup_file}" 2>/dev/null || echo "No output file created"
            exit 1
          fi
          
          # Check if backup was created successfully
          if [ -f "backups/${backup_file}" ]; then
            echo "âœ… Backup created successfully"
            ls -la "backups/${backup_file}"
          else
            echo "âŒ Backup creation failed"
            exit 1
          fi
          
          # Compress backup
          echo "ðŸ—œï¸ Compressing backup..."
          gzip "backups/${backup_file}"
          
          echo "âœ… Backup compressed: backups/${backup_file}.gz"
          ls -la "backups/${backup_file}.gz"
      
      - name: Upload backup to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backups/
          retention-days: 30
      
      - name: Create backup summary
        run: |
          echo "## ðŸ“Š Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup File**: daygen_backup_$(date +%Y%m%d_%H%M%S).sql.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h backups/*.gz | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
