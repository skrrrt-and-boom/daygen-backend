generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id           String         @id
  email        String         @unique
  createdAt    DateTime       @default(now())
  authUserId   String         @unique
  displayName  String?
  credits      Int            @default(20)
  profileImage String?
  updatedAt    DateTime       @updatedAt
  role         UserRole       @default(USER)
  jobs         Job[]
  payments     Payment[]
  r2Files      R2File[]
  subscription Subscription?
  usageEvents  UsageEvent[]
}

model UsageEvent {
  id           String      @id @default(dbgenerated("(gen_random_uuid())::text"))
  userAuthId   String
  provider     String
  model        String?
  prompt       String?
  cost         Int
  balanceAfter Int
  status       UsageStatus @default(COMPLETED)
  metadata     Json?
  createdAt    DateTime    @default(now())
  user         User        @relation(fields: [userAuthId], references: [authUserId], onDelete: Cascade)

  @@index([userAuthId, createdAt(sort: Desc)])
}

model R2File {
  id            String    @id @default(cuid())
  ownerAuthId   String
  fileName      String
  fileUrl       String
  fileSize      Int?
  mimeType      String?
  prompt        String?
  model         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  avatarId      String?
  avatarImageId String?
  deletedAt     DateTime?
  jobId         String?
  productId     String?
  job           Job?      @relation(fields: [jobId], references: [id])
  owner         User      @relation(fields: [ownerAuthId], references: [authUserId], onDelete: Cascade)

  @@index([ownerAuthId, createdAt(sort: Desc)])
  @@index([ownerAuthId, deletedAt])
  @@index([jobId])
}

model Job {
  id          String    @id @default(cuid())
  userId      String
  type        JobType
  status      JobStatus @default(PENDING)
  progress    Int       @default(0)
  resultUrl   String?
  error       String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  user        User      @relation(fields: [userId], references: [authUserId], onDelete: Cascade)
  r2Files     R2File[]

  @@index([userId, status])
  @@index([status, createdAt])
}

model Payment {
  id                    String        @id @default(cuid())
  userId                String
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?       @unique
  amount                Int
  credits               Int
  status                PaymentStatus @default(PENDING)
  type                  PaymentType
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  user                  User          @relation(fields: [userId], references: [authUserId], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([stripeSessionId])
  @@index([stripePaymentIntentId])
}

model Subscription {
  id                   String              @id @default(cuid())
  userId               String              @unique
  stripeSubscriptionId String              @unique
  stripePriceId        String
  status               SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean             @default(false)
  credits              Int
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  user                 User                @relation(fields: [userId], references: [authUserId], onDelete: Cascade)
  cycles               SubscriptionCycle[]
  planId               String?
  plan                 Plan?               @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([stripePriceId])
  @@index([planId])
}


enum UserRole {
  USER
  ADMIN
}

enum JobType {
  IMAGE_GENERATION
  VIDEO_GENERATION
  IMAGE_UPSCALE
  BATCH_GENERATION
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum UsageStatus {
  COMPLETED
  GRACE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentType {
  ONE_TIME
  SUBSCRIPTION
  SUBSCRIPTION_UPGRADE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  PAUSED
}

model WebhookEvent {
  id        String   @id @default(cuid())
  eventId   String   @unique
  type      String
  createdAt DateTime @default(now())
}

model SubscriptionCycle {
  id               String   @id @default(cuid())
  subscriptionId   String
  stripeInvoiceId  String   @unique
  periodStart      DateTime
  periodEnd        DateTime
  creditsGranted   Int
  createdAt        DateTime @default(now())

  subscription     Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, periodStart])
}

model Plan {
  id               String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  code             String   @unique
  name             String
  interval         String
  creditsPerPeriod Int
  graceCredits     Int      @default(0)
  stripePriceId    String   @unique
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  subscriptions    Subscription[]
}

